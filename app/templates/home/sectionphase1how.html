<section id="how-it-works-phase1" class="py-20 bg-gray-50 overflow-hidden">
  <div class="container mx-auto px-4">
    <div class="text-center mb-16">
      <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">
        How Phase 1 Works
      </h2>
      <p class="text-lg text-gray-600 max-w-3xl mx-auto">
        Our cutting-edge AI system streamlines your planning process, ensuring
        clarity and organization for any writing project.
      </p>
    </div>

    <div class="max-w-6xl mx-auto">
      <div class="relative">
        <!-- Process Steps -->
        <div
          class="hidden md:block absolute left-1/2 top-0 bottom-0 w-1 bg-gradient-to-b from-[#0066cc] to-[#003366] transform -translate-x-1/2 z-0"
        ></div>

        <!-- Step 1 -->
        <div
          class="flex flex-col md:flex-row items-center mb-20 relative"
          data-aos="fade-up"
        >
          <div
            class="md:w-1/2 md:pr-12 mb-8 md:mb-0 text-center md:text-right order-2 md:order-1"
          >
            <div
              class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-1"
            >
              <h3 class="text-2xl font-bold text-blue-600 mb-3">
                Upload Your Document
              </h3>
              <p class="text-[#4d4d4d]">
                Submit your Word or PDF file through our simple drag-and-drop
                interface. Our system accepts various document formats to
                accommodate your specific needs.
              </p>
            </div>
          </div>
          <div
            class="md:w-1/2 md:pl-12 flex justify-center md:justify-start order-1 md:order-2 z-10"
          >
            <div class="relative">
              <div
                class="w-16 h-16 bg-[#0066cc] rounded-full flex items-center justify-center text-white text-2xl font-bold shadow-lg"
              >
                1
              </div>
              <div
                class="absolute -inset-4 bg-blue-50 0 rounded-full opacity-50 animate-pulse"
              ></div>
            </div>
          </div>
        </div>

        <!-- Step 2 -->
        <div
          class="flex flex-col md:flex-row items-center mb-20 relative"
          data-aos="fade-up"
          data-aos-delay="100"
        >
          <div
            class="md:w-1/2 md:pr-12 mb-8 md:mb-0 text-center md:text-right order-2"
          >
            <div class="relative">
              <div
                class="w-16 h-16 bg-[#0066cc] rounded-full flex items-center justify-center text-white text-2xl font-bold shadow-lg"
              >
                2
              </div>
              <div
                class="absolute -inset-4 bg-blue-50 rounded-full opacity-50 animate-pulse animation-delay-300"
              ></div>
            </div>
          </div>
          <div class="md:w-1/2 md:pl-12 order-1 z-10">
            <div
              class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-1"
            >
              <h3 class="text-2xl font-bold text-blue-600 mb-3">
                Choose a Template
              </h3>
              <p class="text-[#4d4d4d]">
                Select from our library of predefined templates designed for
                various document types, or customize your own to match your
                specific requirements.
              </p>
            </div>
          </div>
        </div>

        <!-- Step 3 -->
        <div
          class="flex flex-col md:flex-row items-center mb-20 relative"
          data-aos="fade-up"
          data-aos-delay="200"
        >
          <div
            class="md:w-1/2 md:pr-12 mb-8 md:mb-0 text-center md:text-right order-2 md:order-1"
          >
            <div
              class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-1"
            >
              <h3 class="text-2xl font-bold text-blue-600 mb-3">
                AI-Powered Analysis
              </h3>
              <p class="text-[#4d4d4d]">
                Our system scans your document, extracts key points, identifies
                main topics, and structures a detailed writing plan based on the
                content and context of your document.
              </p>
            </div>
          </div>
          <div
            class="md:w-1/2 md:pl-12 flex justify-center md:justify-start order-1 md:order-2 z-10"
          >
            <div class="relative">
              <div
                class="w-16 h-16 bg-[#0066cc] rounded-full flex items-center justify-center text-white text-2xl font-bold shadow-lg"
              >
                3
              </div>
              <div
                class="absolute -inset-4 bg-blue-50 rounded-full opacity-50 animate-pulse animation-delay-600"
              ></div>
            </div>
          </div>
        </div>

        <!-- Step 4 -->
        <div
          class="flex flex-col md:flex-row items-center relative"
          data-aos="fade-up"
          data-aos-delay="300"
        >
          <div
            class="md:w-1/2 md:pr-12 mb-8 md:mb-0 text-center md:text-right order-2"
          >
            <div class="relative">
              <div
                class="w-16 h-16 bg-[#0066cc] rounded-full flex items-center justify-center text-white text-2xl font-bold shadow-lg"
              >
                4
              </div>
              <div
                class="absolute -inset-4 bg-blue-50 rounded-full opacity-50 animate-pulse animation-delay-900"
              ></div>
            </div>
          </div>
          <div class="md:w-1/2 md:pl-12 order-1 z-10">
            <div
              class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-1"
            >
              <h3 class="text-2xl font-bold text-blue-600 mb-3">
                Download &amp; Use
              </h3>
              <p class="text-[#4d4d4d]">
                Get a well-organized plan in Excel format, ready for further
                development. The plan includes structured sections, key points,
                and suggested content organization.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Demo Section -->
    <section id="phase-1">
      <div class="mt-24 max-w-5xl mx-auto">
        <div
          class="bg-white rounded-2xl shadow-xl overflow-hidden"
          data-aos="zoom-in"
        >
          <!-- <div
            class="p-6 bg-gradient-to-r from-[#0066cc] to-[#003366] text-white"
          > -->
          <div
            class="p-6 bg-gradient-to-r from-[#2a83b6] to-[#133c54] text-white"
          >
            <h3 class="text-2xl font-bold font-['Playfair_Display']">
              Writing Plan Generation
            </h3>
            <p class="text-white">
              Upload a sample document and see our AI in action
            </p>
          </div>

          <div class="p-8" id="upload-area-phase1">
            <!-- Processing Animation -->
            <div
              id="upload-processing-phase1"
              class="hidden flex flex-col items-center text-center border-2 border-dashed border-blue-300 rounded-lg p-10 mb-8 transition-all duration-300 bg-blue-50 hover:bg-blue-100"
            >
              <div
                class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mx-auto mb-4"
              ></div>
              <h3 class="text-xl font-semibold text-gray-800 mb-2">
                Processing Your Document
              </h3>
              <p class="text-gray-600 mb-4">
                Please wait while our AI analyzes your file...
              </p>
              <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                <div
                  id="progress-indicator"
                  class="bg-blue-600 h-2.5 rounded-full w-0 transition-all duration-500"
                ></div>
              </div>
              <p id="progress-text" class="text-sm text-gray-500">0%</p>
            </div>

            <!-- file drop area -->
            <div
              id="file-drop-area-phase1"
              class="mb-6 border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50 transition-all hover:border-[#0066cc]"
            >
              <div class="flex flex-col items-center justify-center">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-12 w-12 text-gray-400 mb-3"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  ></path>
                </svg>
                <p
                  class="text-center text-gray-500"
                  id="file-word-name-phase1"
                ></p>
                <p class="text-center text-gray-500">
                  Drag and drop your document here
                </p>
                <p class="text-sm text-gray-400">or</p>
                <button
                  id="browse-button-phase1"
                  class="mt-3 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
                >
                  Browse Files
                </button>
                <input
                  type="file"
                  id="file-input-phase1"
                  accept=".docx"
                  class="hidden"
                />
                <p class="mt-4 text-xs text-gray-400">
                  Supports .docx, .doc, .pdf (Max 10MB)
                </p>
              </div>
            </div>

            <!-- Success Message Div -->
            <div
              id="file-success-area-phase1"
              class="hidden mb-6 border-2 border-dashed border-green-400 rounded-lg p-6 bg-green-50 transition-all"
            >
              <div class="flex flex-col items-center justify-center">
                <!-- Animated Checkmark Icon -->
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-12 w-12 text-green-500 mb-3 animate-bounce"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>

                <!-- Success Message -->
                <p class="text-center text-green-700 text-xl font-semibold">
                  Successful!
                </p>

                <!-- New Upload Button & Download button-->
                <div>
                  <a id="download-a-phase1">
                    <button
                      id="download-button-phase1"
                      class="mt-4 px-6 py-2 bg-[#0066cc] hover:bg-[#003366] text-white rounded-lg transition-colors"
                    >
                      Download Plan
                    </button>
                  </a>

                  <button
                    id="new-upload-button-phase1"
                    class="mt-4 px-6 py-2 bg-[#0066cc] hover:bg-[#003366] text-white rounded-lg transition-colors"
                  >
                    New Upload
                  </button>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="relative">
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >Select Template</label
                >
                <input
                  type="file"
                  id="file-input-phase1-template"
                  accept=".xlsx"
                />
              </div>
            </div>

            <div class="flex justify-center">
              <button
                id="generate-button-phase1"
                class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors duration-300 flex items-center justify-center shadow-lg hover:shadow-xl"
              >
                <span>Generate Writing Plan</span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5 ml-2"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const progressIndicator = document.getElementById("progress-indicator");
      const progressText = document.getElementById("progress-text");

      const socket = io("/phase1", {
        transports: ["websocket"],
        upgrade: false,
      });

      socket.on("connect", () => {
        console.log("Connected to :", socket.id);
      });

      socket.on("message", (msg) => {
        console.log("message :", msg);

        if (msg != null) {
          console.log("setting progress to:", msg.progress);
          progressIndicator.style.width = msg.progress;
          progressText.textContent = msg.msg;
        }
      });

      function joinRoom(roomId) {
        socket.emit("join", { room: roomId });
      }

      function leaveRoom(roomId) {
        socket.emit("leave", { room: roomId });
      }

      // Elements
      const uploadArea = document.getElementById("upload-area-phase1");
      const fileInput1 = document.getElementById("file-input-phase1");
      const fileInput2 = document.getElementById("file-input-phase1-template");
      const browseButton = document.getElementById("browse-button-phase1");
      const fileWordName = document.getElementById("file-word-name-phase1");
      const uploadProcessing = document.getElementById(
        "upload-processing-phase1"
      );
      const resultArea = document.getElementById("file-success-area-phase1");
      const generateButton = document.getElementById("generate-button-phase1");
      const fileDropArea = document.getElementById("file-drop-area-phase1");
      const newUploadButton = document.getElementById(
        "new-upload-button-phase1"
      );
      const downloadA = document.getElementById("download-a-phase1");

      let fileWord = null;
      let fileTemplate = null;

      generateButton.addEventListener("click", handleFile);

      newUploadButton.addEventListener("click", function () {
        fileWord = null;
        fileTemplate = null;
        fileWordName.innerText = "";
        fileDropArea.classList.remove("hidden");
        resultArea.classList.add("hidden");
      });

      // Drag and drop functionality
      uploadArea.addEventListener("dragover", function (e) {
        e.preventDefault();

        uploadArea.classList.add("border-blue-500");
        uploadArea.classList.add("bg-blue-100");
      });

      uploadArea.addEventListener("dragleave", function (e) {
        e.preventDefault();

        uploadArea.classList.remove("border-blue-500");
        uploadArea.classList.remove("bg-blue-100");
      });

      uploadArea.addEventListener("drop", function (e) {
        e.preventDefault();
        const files = e.dataTransfer.files;
        fileWordName.innerText = files[0].name;
        fileWordName.style.color = "red";
        fileWordName.style.fontWeight = "bold";
        fileWord = files[0];
      });

      // Browse button functionality
      browseButton.addEventListener("click", function () {
        fileInput1.click();
      });

      fileInput1.addEventListener("change", function () {
        fileWordName.innerText = fileInput1.files[0].name;
        fileWordName.style.color = "red";
        fileWordName.style.fontWeight = "bold";
        fileWord = fileInput1.files[0];
      });

      fileInput2.addEventListener("change", function () {
        fileTemplate = fileInput2.files[0];
      });

      async function handleFile() {
        console.log("handle file is called !");
        if (!fileWord || !fileTemplate) {
          alert("upload both files !");
          return;
        }

        const zip = new JSZip();
        if (fileWord) zip.file("word_file.docx", fileWord);
        if (fileTemplate) zip.file("excel_file.xlsx", fileTemplate);

        const uploadId = createUUID();
        joinRoom(uploadId);
        fileDropArea.classList.add("hidden");
        uploadProcessing.classList.remove("hidden");
        // Generate the zip file
        const zipFile = await zip.generateAsync({ type: "blob" });

        // Create a new FormData and append the compressed zip file
        const formData = new FormData();

        formData.append("upload_id", uploadId);
        formData.append("zip_file", zipFile, "files.zip");

        fetch("/upload-phase1", {
          method: "POST",
          body: formData,
          credentials: "include",
        })
          .then((res) => {
            if (res.redirected) {
              window.location.href = res.url;
              console.log("redirected is called!");
              return;
            }

            if (res.status === 400) {
              throw new Error("bad request");
            }

            if (!res.ok) {
              throw new Error("network response was not ok !");
            }

            console.log("blob is created ");
            return res.blob();
          })
          .then(async (blob) => {
            const jsZipInstance = new JSZip();
            const zipContent = await jsZipInstance.loadAsync(blob);
            // Extract the .xlsx file from the zip
            const xlsxFile = await zipContent
              .file("processed_result.xlsx")
              .async("blob");

            uploadProcessing.classList.add("hidden");
            const xlsxUrl = window.URL.createObjectURL(xlsxFile);
            console.dir(xlsxUrl);
            downloadA.href = xlsxUrl;
            downloadA.download = "writing_plan.xlsx";
            resultArea.classList.remove("hidden");
          })
          .catch((error) => {
            console.log(error);
            uploadProcessing.classList.add("hidden");
            uploadArea.classList.remove("hidden");
          })
          .finally(() => {
            console.log("upload id :", uploadId);
            leaveRoom(uploadId);
            progressIndicator.style.width = "0%";
            progressText.textContent = "";
          });
      }

      function createUUID() {
        let dt = new Date().getTime();

        const uuid = "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            const r = (dt + Math.random() * 16) % 16 | 0;
            dt = Math.floor(dt / 16);
            return (c == "x" ? r : (r & 0x3) | 0x8).toString(16);
          }
        );

        return uuid;
      }
    });
  </script>
</section>
